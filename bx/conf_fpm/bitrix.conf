# cache condition variable
set $usecache "";
if ($is_global_cache = 1)                     { set $usecache "${usecache}A"; }

# main config without processing cache pages
include bx/conf_fpm/bitrix_general.conf;

# directories page processing
location ~ /$ {
  
  set $cache_file "bitrix/html_pages$general_key/index@$args.html";

  # test file conditions
  if (-f "$docroot/bitrix/html_pages/.enabled") { set $usecache "${usecache}B"; }
  if (-f "$docroot/$cache_file")                { set $usecache "${usecache}C"; }

  # create rewrite if cache-file exists
  if ($usecache = "ABC" ) { rewrite .* /$cache_file last; }

   #error_page 404 = @bitrix;
   try_files       $uri $uri/ @bitrix;
    add_header X-Bitrix "directories page processing";
   # to avoid not found error for virtual index.php
   #log_not_found off;
}

# Main location
location / {
    try_files       $uri $uri/ @bitrix;
    #error_page 404 = @bitrix;
    add_header X-Bitrix "main location";
    # to avoid not found error for virtual index.php
    #log_not_found off;
}
