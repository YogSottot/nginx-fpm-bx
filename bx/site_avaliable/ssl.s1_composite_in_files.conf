# Ansible managed
#########################################################
# configuration for https-site:
# site_name:                 default
# site_root:                 /home/bitrix/www
# site_composite:            disable
# site_composite_id:         02
# site_composite_var:        $is_site_composite_02
# site_composite_storage:    memcached
# site_composite_memcached:  unix:///tmp/memcached.sock:11211
# web_cluster:               disable
##########################################################
server {
    listen 443 default_server http2;
    server_name _;

    access_log /var/log/nginx/default_access.log main;
    error_log  /var/log/nginx/default_error.log warn;

    # Enable SSL connection
    include bx/conf/ssl.conf;


    set $docroot		"/home/bitrix/www";
    root            "/home/bitrix/www";
    fastcgi_ignore_client_abort off;
    index index.php;

    server_name_in_redirect off;
    set $php_sock  unix:/var/run/php-fpm/www.socket;

    if_modified_since     before;

    # composite variables
    set $composite_cache    "bitrix/html_pages/${host}${composite_key}/index@${args}.html";
    set $composite_file     "${docroot}/${composite_cache}";

    # config file
    set $composite_enabled  "${docroot}/bitrix/html_pages/.enabled";
    # if test pass through general tests:
    set $use_composite_cache "";
    # global site test, the same for all sites on the server
    if ($is_global_composite  = 1) {set $use_composite_cache "A";}
    # personal site tests, generated by site config
    if ($is_site_composite_02 = 1) {set $use_composite_cache "${use_composite_cache}B";}



    # Include parameters common to all websites
    include bx/conf_fpm/bitrix_general.conf;

    # main location with processing composite
    location / {

        if (-f $composite_enabled)     { set $use_composite_cache "${use_composite_cache}C"; }

        # test cache file exists
        if (-f $composite_file)  { set $use_composite_cache "${use_composite_cache}D"; }

        if ($use_composite_cache = "ABCD") { rewrite .* /$composite_cache last; }

        error_page 404 = @bitrix;
        # to avoid not found error for virtual index.php
        log_not_found off;
    }

        # php-fpm location
	location @bitrix {
		fastcgi_pass    $php_sock;
		fastcgi_index   index.php;
		include fastcgi_params;
		fastcgi_param php_admin_value "session.save_path /tmp/php_sessions/www";
		fastcgi_param php_admin_value "upload_tmp_dir /tmp/php_upload/www";
		fastcgi_param SCRIPT_FILENAME $document_root/bitrix/urlrewrite.php;
	}

	# cache condition variable
	set $usecache "";
	if ($is_global_cache = 1)                     { set $usecache "${usecache}A"; }

	# php file processing
	location ~ \.php$ {

	set $cache_file "bitrix/html_pages$general_key@$args.html";

	# test file conditions
	if (-f "$docroot/bitrix/html_pages/.enabled") { set $usecache "${usecache}B"; }
	if (-f "$docroot/$cache_file") { set $usecache "${usecache}C"; }

	# create rewrite if cache-file exists
	if ($usecache = "ABC" ) { rewrite .* /$cache_file last; }
	try_files $uri @bitrix;
	fastcgi_pass    $php_sock;
	fastcgi_index   index.php;
	fastcgi_param php_admin_value "session.save_path /tmp/php_sessions/www";
	fastcgi_param php_admin_value "upload_tmp_dir /tmp/php_upload/www";
	fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
	include fastcgi_params;
	}
        
    # Include munin and nagios web
    include bx/server_monitor.conf;
}
